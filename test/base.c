#include "base.h"
#include <stdio.h>

#define SCREEN_XN	106
#define SCREEN_YN	40
#define SCREEN_RN	(SCREEN_PX * FONT_YN)
#define KEYWAIT		20
#define KEYWAITREP	4

u16 curColor;
u8 interruptCount;
extern const u8 gFont[];

static u8 cursX, cursY, cursActive, printer, frameCount;
static u8 curKey, lastKey, keyTime;
static u8 lastPort[16];

//// DISPLAY ////

void cls() {
	memset_align(VRAM, 0, 2 * SCREEN_PX * SCREEN_PY);
	cursX = cursY = cursActive = 0;
}

static void writeChar(char c) {
	if (c < 0x20) c = 0x20;
	u8 *sp = (u8 *)&gFont[FONT_YN * (c - 0x20)];
	u16 *dp = VRAM + SCREEN_RN * cursY + 6 * cursX + 3;
	for (u8 y = 0; y < FONT_YN; y++) {
		u8 d = *sp++;
		dp[0] = d & 0x80 ? curColor : 0;
		dp[1] = d & 0x40 ? curColor : 0;
		dp[2] = d & 0x20 ? curColor : 0;
		dp[3] = d & 0x10 ? curColor : 0;
		dp[4] = d & 0x08 ? curColor : 0;
		dp[5] = d & 0x04 ? curColor : 0;
		dp += SCREEN_PX;
	}
}

static void cursor() {
	if (!cursActive) return;
	u16 *dp = VRAM + SCREEN_RN * cursY + 6 * cursX + 3;
	for (u8 y = 0; y < FONT_YN; y++) {
		dp[0] = ~dp[0];
		dp[1] = ~dp[1];
		dp[2] = ~dp[2];
		dp[3] = ~dp[3];
		dp[4] = ~dp[4];
		dp[5] = ~dp[5];
		dp += SCREEN_PX;
	}
}

void newLine() {
	cursX = 0;
	if (++cursY >= SCREEN_YN) {
		--cursY;
		memcpy_align(VRAM, VRAM + SCREEN_RN, 2 * SCREEN_PX * SCREEN_PY);
	}
	cursor();
}

void putchar(char c) {
	if (printer) STDOUT = c;
	else if (c == '\n') {
		cursor();
		newLine();
	}
	else {
		writeChar(c);
		if (++cursX >= SCREEN_XN) newLine();
		else cursor();
	}
	return 0;
}

void puts_n(char *p) {
	while (*p) putchar(*p++);
}

void locate(u8 x, u8 y) {
	cursX = x;
	cursY = y;
}

void color(u16 color) {
	curColor = color;
}

void cursorOn() {
	if (!cursActive) {
		cursActive = 1;
		cursor();
	}
}

void cursorOff() {
	if (cursActive) {
		cursActive = 0;
		cursor();
	}
}

void setPrinter(u8 f) {
	printer = f;
}

void _log(const char *format, ...) {
	u8 last = printer;
	printer = 1;
	va_list ap;
	va_start(ap, format);
	xvprintf(format, ap);
	va_end(ap);
	putchar('\n');
	printer = last;
}

void interrupt2() {
	interruptCount++;
}

//// KEYBOARD ////

void interrupt3() {
	static const u8 normal[] = {
		0x61, 0x73, 0x64, 0x66, 0x68, 0x67, 0x7a, 0x78,
		0x63, 0x76, 0x00, 0x62, 0x71, 0x77, 0x65, 0x72,
		0x79, 0x74, 0x31, 0x32, 0x33, 0x34, 0x36, 0x35,
		0x5e, 0x39, 0x37, 0x2d, 0x38, 0x30, 0x5b, 0x6f,
		0x75, 0x40, 0x69, 0x70, 0x0a, 0x6c, 0x6a, 0x3a,
		0x6b, 0x3b, 0x5d, 0x2c, 0x2f, 0x6e, 0x6d, 0x2e,
		0x00, 0x20, 0x00, 0x08, 0x00, 0x1b, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x2e, 0x00, 0x2a, 0x00, 0x2b, 0x00, 0x0c,
		0x00, 0x00, 0x00, 0x2f, 0x0a, 0x00, 0x2d, 0x00,
		0x00, 0x3d, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
		0x36, 0x37, 0x00, 0x38, 0x39, 0x5c, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03,
		0x00, 0x00, 0x00, 0x0c, 0x5c, 0x08, 0x00, 0x03,
		0x00, 0x00, 0x00, 0x1d, 0x1c, 0x1f, 0x1e, 0x00,
	};
	static const u8 shift[] = {
		0x41, 0x53, 0x44, 0x46, 0x48, 0x47, 0x5a, 0x58,
		0x43, 0x56, 0x00, 0x42, 0x51, 0x57, 0x45, 0x52,
		0x59, 0x54, 0x21, 0x22, 0x23, 0x24, 0x26, 0x25,
		0x00, 0x29, 0x27, 0x3d, 0x28, 0x00, 0x00, 0x4f,
		0x55, 0x00, 0x49, 0x50, 0x0a, 0x4c, 0x4a, 0x2a,
		0x4b, 0x2b, 0x00, 0x3c, 0x3f, 0x4e, 0x4d, 0x3e,
		0x00, 0x20, 0x00, 0x08, 0x00, 0x1b, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x2e, 0x00, 0x2a, 0x00, 0x2b, 0x00, 0x0b,
		0x00, 0x00, 0x00, 0x3f, 0x0a, 0x00, 0x3d, 0x00,
		0x00, 0x3d, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
		0x36, 0x37, 0x00, 0x38, 0x39, 0x00, 0x5f, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03,
		0x00, 0x00, 0x00, 0x0b, 0x00, 0x08, 0x00, 0x03,
		0x00, 0x5f, 0x00, 0x1d, 0x1c, 0x1f, 0x1e, 0x00,
	};
	u8 d = KEYDATA;
	curKey = d & 0x80 ? (KEYMOD ? shift : normal)[d & 0x7f] : 0;
}

u8 keyDown(u8 repeat) {
	if (!lastKey || repeat && keyTime == interruptCount) {
		keyTime = interruptCount + (lastKey ? KEYWAITREP : KEYWAIT);
		lastKey = curKey;
		return curKey;
	}
	else {
		lastKey = curKey;
		return 0;
	}
}

//// INIT ////

void init() {
	memset(lastPort, 0xff, sizeof(lastPort));
	curKey = lastKey = keyTime = 0;
	cursX = cursY = cursActive = printer = 0;
	frameCount = 0;
	color(WHITE);
	xdev_out(putchar);
}
